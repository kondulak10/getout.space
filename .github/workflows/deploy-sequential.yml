name: Sequential Deploy (Backend ‚Üí Frontend)

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy-sequential.yml'
  workflow_dispatch:

concurrency:
  group: deploy-sequential-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: eu-north-1
  ECR_REPOSITORY: getout-backend
  ECS_SERVICE: getout-backend-service
  ECS_CLUSTER: getout-cluster
  ECS_TASK_DEFINITION: getout-backend
  CONTAINER_NAME: backend

jobs:
  # Step 0: Check which paths changed
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check which paths changed
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  # Step 1: Deploy Backend (ONLY if backend changed)
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend
          docker build \
            --build-arg CACHE_BUST=${{ github.run_id }} \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Download current task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition > task-definition.json

      - name: Fill in the new image ID in the Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@v2
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Backend deployment complete
        run: |
          echo "‚úÖ Backend deployed successfully!"
          echo "üîÑ Frontend deployment will start after this completes"

  # Step 2: Deploy Frontend (AFTER backend, ONLY if frontend changed)
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [check-changes, deploy-backend]
    # Run if: frontend changed AND (backend succeeded OR backend was skipped)
    if: |
      needs.check-changes.outputs.frontend == 'true' &&
      always() &&
      (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Configure Font Awesome Pro registry
        working-directory: ./frontend
        run: |
          echo "@awesome.me:registry=https://npm.fontawesome.com/" > .npmrc
          echo "@fortawesome:registry=https://npm.fontawesome.com/" >> .npmrc
          echo "//npm.fontawesome.com/:_authToken=${{ secrets.FONTAWESOME_TOKEN }}" >> .npmrc

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build:prod
        env:
          VITE_BACKEND_URL: https://api.getout.space
          VITE_MAPBOX_TOKEN: pk.eyJ1Ijoia291ZGVsa2EiLCJhIjoiY2o4b3YzajV4MDljOTJxcnNnOHJvY2lpMCJ9.ILCCsALFB59ZFSegrCTruA
          VITE_SENTRY_DSN_FRONTEND: ${{ secrets.SENTRY_DSN_FRONTEND }}
          VITE_AMPLITUDE_API_KEY: ${{ secrets.AMPLITUDE_API_KEY }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-north-1

      - name: Deploy to S3
        working-directory: ./frontend
        run: |
          # Upload hashed assets with long-term caching (1 year)
          aws s3 sync dist/assets/ s3://getout-space-web/assets/ --delete --cache-control "public, max-age=31536000, immutable"

          # Upload other files (images, SVGs) with moderate caching (1 day)
          aws s3 sync dist/ s3://getout-space-web/ --exclude "assets/*" --exclude "index.html" --exclude "profile-images/*" --exclude "test-data/*" --cache-control "public, max-age=86400"

          # Upload index.html with NO caching at all (aggressive)
          aws s3 cp dist/index.html s3://getout-space-web/index.html --cache-control "no-cache, no-store, must-revalidate" --metadata-directive REPLACE

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation --distribution-id E32M9JXZK477DJ --paths "/index.html" "/"

      - name: Deployment complete
        run: |
          echo "‚úÖ Full deployment successful!"
          echo "üåê Website: https://getout.space"
          echo "üîß API: https://api.getout.space"
